<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMCU HMS - Mode Hors Ligne</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .offline-container {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
        }

        .offline-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 2rem;
            background: #f8f9fa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #6c757d;
        }

        .offline-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #2d3748;
        }

        .offline-message {
            font-size: 1.1rem;
            color: #718096;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .offline-features {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .offline-features h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #2d3748;
            text-align: center;
        }

        .feature-list {
            list-style: none;
        }

        .feature-list li {
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
        }

        .feature-list li:before {
            content: "âœ“";
            color: #48bb78;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .retry-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 1rem;
        }

        .retry-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .cache-button {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cache-button:hover {
            background: #667eea;
            color: white;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-offline {
            background: #fed7d7;
            color: #c53030;
        }

        .status-online {
            background: #c6f6d5;
            color: #2f855a;
        }

        .cached-data {
            margin-top: 2rem;
            padding: 1rem;
            background: #e6fffa;
            border-radius: 10px;
            border-left: 4px solid #38b2ac;
        }

        .cached-data h4 {
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .cached-data p {
            color: #4a5568;
            font-size: 0.9rem;
        }

        @media (max-width: 600px) {
            .offline-container {
                padding: 2rem;
            }
            
            .offline-title {
                font-size: 1.5rem;
            }
            
            .retry-button, .cache-button {
                display: block;
                width: 100%;
                margin: 0.5rem 0;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status status-offline" id="connectionStatus">
        ðŸ“¡ Hors ligne
    </div>

    <div class="offline-container">
        <div class="offline-icon">
            ðŸ“¡
        </div>
        
        <h1 class="offline-title">Mode Hors Ligne</h1>
        
        <p class="offline-message">
            Vous Ãªtes actuellement hors ligne. L'application CMCU HMS continue de fonctionner 
            avec les donnÃ©es mises en cache et synchronisera automatiquement lorsque la connexion sera rÃ©tablie.
        </p>

        <div class="offline-features">
            <h3>FonctionnalitÃ©s disponibles hors ligne :</h3>
            <ul class="feature-list">
                <li>Consultation des patients rÃ©cemment consultÃ©s</li>
                <li>CrÃ©ation de nouveaux patients (synchronisation automatique)</li>
                <li>Sauvegarde automatique des brouillons</li>
                <li>Consultation des statistiques mises en cache</li>
                <li>AccÃ¨s aux donnÃ©es rÃ©cemment consultÃ©es</li>
            </ul>
        </div>

        <div class="cached-data" id="cachedDataInfo" style="display: none;">
            <h4>ðŸ“Š DonnÃ©es mises en cache</h4>
            <p id="cacheDetails">Chargement des informations du cache...</p>
        </div>

        <div style="margin-top: 2rem;">
            <button class="retry-button" onclick="retryConnection()">
                ðŸ”„ RÃ©essayer la connexion
            </button>
            <button class="cache-button" onclick="showCachedData()">
                ðŸ’¾ Voir les donnÃ©es locales
            </button>
        </div>
    </div>

    <script>
        // Check connection status
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            
            if (navigator.onLine) {
                statusEl.textContent = 'âœ… En ligne';
                statusEl.className = 'connection-status status-online';
                
                // Redirect to main app if online
                setTimeout(() => {
                    window.location.href = '/admin/dashboard';
                }, 1000);
            } else {
                statusEl.textContent = 'ðŸ“¡ Hors ligne';
                statusEl.className = 'connection-status status-offline';
            }
        }

        // Retry connection
        function retryConnection() {
            const button = event.target;
            const originalText = button.textContent;
            
            button.textContent = 'ðŸ”„ VÃ©rification...';
            button.disabled = true;
            
            // Simulate connection check
            setTimeout(() => {
                updateConnectionStatus();
                button.textContent = originalText;
                button.disabled = false;
                
                if (navigator.onLine) {
                    window.location.href = '/admin/dashboard';
                }
            }, 2000);
        }

        // Show cached data information
        async function showCachedData() {
            const cachedDataEl = document.getElementById('cachedDataInfo');
            const cacheDetailsEl = document.getElementById('cacheDetails');
            
            cachedDataEl.style.display = 'block';
            
            try {
                // Try to access IndexedDB for cached data info
                if ('indexedDB' in window) {
                    const dbRequest = indexedDB.open('CMCU_HMS_Offline', 1);
                    
                    dbRequest.onsuccess = function(event) {
                        const db = event.target.result;
                        let info = [];
                        
                        // Check each object store
                        const stores = ['patients', 'consultations', 'form_drafts', 'sync_queue'];
                        let completed = 0;
                        
                        stores.forEach(storeName => {
                            if (db.objectStoreNames.contains(storeName)) {
                                const transaction = db.transaction([storeName], 'readonly');
                                const store = transaction.objectStore(storeName);
                                const countRequest = store.count();
                                
                                countRequest.onsuccess = function() {
                                    const count = countRequest.result;
                                    if (count > 0) {
                                        info.push(`${getStoreFriendlyName(storeName)}: ${count} Ã©lÃ©ments`);
                                    }
                                    
                                    completed++;
                                    if (completed === stores.length) {
                                        if (info.length > 0) {
                                            cacheDetailsEl.innerHTML = info.join('<br>');
                                        } else {
                                            cacheDetailsEl.textContent = 'Aucune donnÃ©e mise en cache disponible.';
                                        }
                                    }
                                };
                            } else {
                                completed++;
                            }
                        });
                    };
                    
                    dbRequest.onerror = function() {
                        cacheDetailsEl.textContent = 'Impossible d\'accÃ©der aux donnÃ©es mises en cache.';
                    };
                } else {
                    cacheDetailsEl.textContent = 'Le stockage local n\'est pas disponible dans ce navigateur.';
                }
            } catch (error) {
                cacheDetailsEl.textContent = 'Erreur lors de l\'accÃ¨s aux donnÃ©es mises en cache.';
            }
        }

        function getStoreFriendlyName(storeName) {
            const names = {
                'patients': 'Patients',
                'consultations': 'Consultations',
                'form_drafts': 'Brouillons',
                'sync_queue': 'En attente de synchronisation'
            };
            return names[storeName] || storeName;
        }

        // Listen for online/offline events
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // Initial status check
        updateConnectionStatus();

        // Periodic connection check
        setInterval(updateConnectionStatus, 30000); // Check every 30 seconds

        // Auto-show cached data after 3 seconds
        setTimeout(() => {
            showCachedData();
        }, 3000);

        // Service Worker registration check
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(function(registration) {
                console.log('Service Worker is ready');
            });
        }
    </script>
</body>
</html>
